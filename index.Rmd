---
title: "Introducing the I'-chart: an improved individuals chart"
author: "Jacob Anhøj, Wayne Taylor & Mohammed Amin Mohammed"
date: "`r Sys.Date()` WORK IN PROGRESS"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    css: style.css
bibliography: [references.bib, packages.bib]
link-citations: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo      = FALSE,
                      cache     = TRUE,
                      message   = FALSE,
                      fig.asp   = 0.5,
                      fig.width = 9,
                      dev       = 'svg')

library(qicharts2)
# library(patchwork)
library(tidyverse)

bac <- read_csv('data/bacteremia.csv', comment = '#')
hba1c <- read_csv('data/diabetes_hba1c.csv', comment = '#')

# Function to plot control limits from the I'-chart on top of Shewhart chart
compplot <- function(x, y, n = NULL, chart, ...) {
  p1 <- qic(x, y, n, chart = chart, ...)
  p2 <- qic(x, y, n, chart = 'ip', ...)
 
  p1 +
    geom_line(aes(y = lcl), data = p2$data, colour = 'tomato') +
    geom_line(aes(y = ucl), data = p2$data, colour = 'tomato')
}
```

----

## Abstract

...

## Introduction

Statistical Process Control (SPC) is widely used in healthcare to monitor and improve the quality and safety of care delivery processes [@carey2002a;@carey2002b;@mohammed2008]. At its core, SPC methodology distinguishes between two types of variation: common cause variation, which reflects inherent fluctuations within a stable process and special cause variation, which signals a change in the underlying process due to an assignable cause.

SPC charts help users visualise the behaviour of data from a process and identify signals of special cause variation using statistically defined control limits.

There are scores of SPC charts and choosing the appropriate chart can be less than straightforward, especially in healthcare, where data structures are often complex and varied. Measurement data, counts, proportions, and rates with changing denominators are all common -- each requiring a different type of control chart.

Compounding this challenge is the fact that some practitioners lack formal statistical training, and software defaults often promote the use of a single chart type, typically the Individuals (I-)chart, regardless of whether it is the most appropriate. These issues can lead to the misapplication of SPC charts, generating misleading signals and undermining improvement efforts.

Among SPC charts, the I-chart is especially popular for its simplicity and flexibility. It was originally developed for settings where data are collected as single measurements over time -- for example, daily blood pressure readings or individual lab test turnaround times -- but have proven useful also for count data like complication rates or procedure compliance. For this reason, the I-chart is often referred to as the Swiss Army Knife of SPC [@wheeler2000, 142].

Unlike other SPC charts, the I-chart estimates process variation directly from the moving ranges between successive data points [@nelson1982] because the data are individual data points (subgroup size = 1). So the I-chart operates under a key assumption: that each data point reflects the same underlying area of opportunity -- for example, comparable patient volumes, observation periods, or sample sizes.

In many healthcare contexts, this assumption does not hold. For instance, the percentage of patients with post-surgical complications depends on the number of patients who underwent surgery (the denominator), which varies over time. When such variation in subgroup sizes exists, the use of the I-chart becomes problematic, because the I-chart assumes a constant subgroup size or area of opportunity. This assumption can lead to misleading control limits, and this is why the use of the I-chart for such data remains controversial.

To address this limitation, Taylor recently proposed the normalised I-chart or the I'-chart (pronounced: I-prime chart), a modified version of the I-chart, that accommodates varying subgroup sizes [@taylor2018].

In this paper, we introduce the I'-chart, outline its theoretical foundation and evaluate its performance using a range of healthcare data sets. Our paper is guided by the following practical questions:

a. How does the I'-chart compare with the I-chart for subgroup sizes = 1?

a. How does the I'-chart accommodate varying subgroup sizes?

a. How does the I'-chart compare with other widely used SPC charts (P, C, U, and X-bar charts)?

## Materials and methods

### Procedure for calculating centre line and control limits

The general formula for calculating control limits for SPC charts is:

$$
\text{control limits} = CL\pm3SD
$$

where CL is the centre line (usually the average), and SD is the standard variation of the common cause variation. The calculation of SD depends on the type of data involved.

In particular, SD for the I-chart is calculated using:

$$
SD = \frac{\overline{MR}}{1.128}
$$

where $\overline{MR}$ is the average moving range, that is the average of the absolute differences between successive data points.

The control limits are then calculated using:

$$
CL\pm2.66\overline{MR}
$$

The procedure for calculating control limits for the I'-chart adjusts the moving ranges by a factor that depends on the subgroup sizes. We use the following symbols:

* n = numerators
* d = denominators (subgroup sizes)
* o = number of subgroups
* i = i^th^ data value

Values to plot:

$$
y = \frac{n}{d}
$$

Centre line:

$$
CL = \frac{\sum{n}}{\sum{d}}
$$

Standard deviation of i^th^ data point:

$$
s_i = \sqrt{\frac{\pi}{2}}\frac{\vert{}y_i-y_{i-1}\vert{}}{\sqrt{\frac{1}{d_i}+\frac{1}{d_{i-1}}}}
$$

Average standard deviation:

$$
\bar{s} = \frac{\sum{s}}{o}
$$

Control limits:

$$
\text{control limits} = CL \pm 3 \frac{\bar{s}}{\sqrt{d_i}}
$$

Note that when the denominator is 1, the formula simplifies to the standard I-chart form: $CL\pm2.66\overline{MR}$.

### Data sets

To demonstrate the use of I'-charts on aggregated measurement data with varying subgroup sizes we used data from a regional outpatient clinic for children with diabetes. For privacy purposes, data were aggregated in advance including the monthly number of children who visited the clinic and their average glycated haemoglobin (HbA1c, a measure of long term blood glucose levels). Date are presented in Table \@ref(tab:tabhba1c).

To construct the control charts, we used R [@r-base] with qicharts2  [@qicharts2], which contains functions for Shewhart control charts in addition to functions for prime charts for proportions and rates with large denominators and for the I'-chart.

To demonstrate the use of I'-charts on count data we used data on bacteremia cases (Table \@ref(tab:tabbac)).

Data sets and R code are available from the GitHub repository (https://github.com/anhoej/i_prime_chart).

Additionally, we constructed a large number of I'-charts using both random data from normal, binomial, and Poisson distributions and several other data sets from clinical practice. See the appendix for examples of additional plots.

## Results

### I'-chart for measurement data with denominator

Figure \@ref(fig:ichart) is an I-chart of the monthly HbA1c averages from Table \@ref(tab:tabhba1c). Notice the data point above the upper control limit in April 2020 suggesting a special cause. However, when plotting aggregated measurement data, the I-chart does not account for variations in subgroup size.

```{r ichart, fig.cap="I-chart of average HbA1c without denominator. The grey region represents the region between the control limits."}
qic(month, avg_hba1c,
    data = hba1c,
    chart = 'i',
    title = NULL,
    ylab = 'mmol / mol',
    xlab = 'Month')
```

The I'-chart in Figure \@ref(fig:ipchart) takes the subgroup size (number of patients) into account and adjusts the control limits correspondingly. April 2020 was the first month of lockdown during Covid-19 in Denmark, and the number of patients seen during this month was significantly lower than usual, which allowed for larger than usual common cause variation in measurements and consequently wider control limits this month. So, when the subgroup size is taken into account, the apparent special cause in Figure \@ref(fig:ichart) is actually within the limits of the expected common cause variation. Also, notice that the centre lines are a bit different (60.6 vs 60.3), because the I'-chart uses the weighted rather than the unweighted mean of the averages.

```{r ipchart, fig.cap="I'-chart of average HbA1c with denominator."}
qic(month, avg_hba1c * n, n,
    data = hba1c,
    chart = 'ip',
    title = NULL,
    ylab = 'mmol / mol',
    xlab = 'Month')
```

### I'-chart vs P and U charts for count data

In the following plots, the control limits from the I'-chart algorithm are superimposed as red lines on the original Shewhart charts.

Figure \@ref(fig:pchart) is a P control chart of the percentage of patients with bacteremia from Table \@ref(tab:tabbac) who died within 30 days after infection. As seen, the I'-chart limits are (in this case) a bit wider. However, the difference is, for practical purposes, negligible. This is generally the case when counts are 25 or less, where the counts follow the binomial distribution.  This assumption frequently does not hold for higher counts, and the I' and P' charts are preferred.

```{r pchart, fig.cap="P chart of proportion patients who died of bacteremia. Grey background: control limits from P chart. Red lines: control limits from I'-chart."}
compplot(bac$month, bac$deaths, bac$patients,
         chart = 'p',
         title = NULL,
         xlab = 'Month')
```

This observation aligns with our experience testing various datasets comparing Shewhart control charts (Xbar, P, C, and U) with I'-chart limits (see Appendix for examples). While the I'-chart limits are sometimes slightly wider or narrower than the original limits, the differences are rarely significant enough to affect the analysis conclusions.

Figure \@ref(fig:ppchart) plots the same data as Figure \@ref(fig:pchart) but the original control limits have been calculated using the procedure for P' charts as suggested by Laney [@laney2002; @mohammed2013].

```{r ppchart, fig.cap="P' chart of proportion patients who died of bacteremia. Grey background: control limits from P’ chart.  Red lines: control limits from I’ chart."}
compplot(bac$month, bac$deaths, bac$patients,
         chart = 'pp',
         title = NULL,
         xlab = 'Month')
```

As seen (and expected from theory), the I'-chart limits match the P'-chart limits. This observation has also been confirmed with other datasets and with the U- and U'-chart of infection rates as demonstrated below (figures \@ref(fig:uchart) and \@ref(fig:upchart)).

```{r uchart, fig.cap="U chart of infection rates. Grey background: control limits from U chart.  Red lines: control limits from I’ chart."}
compplot(bac$month, bac$ha_infections, bac$risk_days,
         chart = 'u',
         multiply = 10000,
         title = NULL,
         ylab = 'Infections per 10,000 risk days',
         xlab = 'Month')
```

```{r upchart, fig.cap="U' chart of infection rates. Grey background: control limits from U' chart.  Red lines: control limits from I' chart."}
compplot(bac$month, bac$ha_infections, bac$risk_days,
         chart = 'up',
         multiply = 10000,
         title = NULL,
         ylab = 'Infections per 10,000 risk days',
         xlab = 'Month')
```

## Discussion and conclusion

We introduced and evaluated the performance and applicability of the I'-chart, a modified form of the traditional Individuals I-chart, designed to account for variation in subgroup sizes.

We have three key findings:

a.  The I'-chart produces results that exactly matches the original I-chart when applied to individual measurement data (subgroup size = 1). This validates the I'-chart as a generalization rather than a replacement, ensuring continuity for users familiar with the original method.

a. The I'-chart produces control limits that are "wavy" or undulating when denominators change over time. This visual representation offers added insight, making variability in data precision explicit and encouraging more insightful interpretation, while reducing the risk of false signals or missed alarms.

a. The I'-chart closely approximates the behaviour of Laney’s prime charts (P'-chart and U'-charts) and shows reasonable alignment with other popular SPC charts (X-bar, C-, U-, and P-charts).

In addition, for measurement and count data with varying denominators, the I'-chart adjusts the centre line by using the weighted rather than the unweighted average for centre line. This makes it more sensitive and appropriate in real-world healthcare settings where case volume, exposure time, or other denominators often vary over time.

Consequently, the I' chart can be used to normalize non-count data, like the averages, where a P' and U' chart do not apply.

A key strength of the I'-chart is that it maintains the simplicity of the I-chart while offering a more context-sensitive representation of variation. 

One potential barrier to the adoption of the I'-chart is its more complex formulae compared to the standard I-chart. Calculating variable control limits that adjust for changing denominators involves additional statistical steps, which may be a barrier to practitioners accustomed to simpler SPC methods. However, this complexity is readily overcome with modern software tools, which can automate these calculations and present the results in user-friendly formats.

As with other advanced analytic techniques in healthcare, once embedded in software, the additional complexity becomes largely invisible to end users -- allowing them to benefit from more accurate and context-sensitive charts without increasing the technical burden. 

We recommend that SPC software incorporate the I'-chart and make it easy for users to compare traditional SPC charts (e.g. I- and P-charts, etc) alongside the I'-chart, because this side-by-side comparison of data using different SPC charts itself can also be insightful [@mohammed2013a].

The I'-chart has superior design properties to the traditional I-chart and so merits broader use and evaluation. Our findings demonstrate that the I'-chart retains the simplicity and intuitive appeal of the I-chart whilst accommodating variation in subgroup sizes, making it suitable for both measurement and count data. 

Given the introduction of the improved I'-chart, which is specifically designed for subgrouped data, the continued default use of the traditional I-chart in such contexts is increasingly difficult to justify.

We are keen to learn how others in the field perceive its value and whether it enhances their ability to monitor and improve processes using real-world healthcare data.

## Data sets

### Diabetes HbA1c data

* 43 observations of 3 variables:
    - month (date): month of measurements
    - avg_hba1c (numeric): average of HbA1c measurements
    - n (integer): number of patients

```{r tabhba1c, tab.cap='Diabetes HbA1c data set.'}
knitr::kable(hba1c)
```

### Bacteremia data

* 24 observations of 5 variables:
    - month (date): month of infection
    - ha_infections (numeric): number of hospital acquired infections
    - risk_days (numeric): number of patient days without infection
    - deaths (numeric): 30-day mortality after all-cause (community + hospital) infection
    - patients (numeric): number of patients with all-cause infection

```{r tabbac, tab.cap='Bacteremia data set.'}
knitr::kable(bac)
```

## Appendix: Supplementary plots

The following plots were generated using pseudo-random data drawn from normal, binomial, and Poisson distributions in R. For instance, the function call `rnorm(24, mean = 9, sd = 3)` produces a vector of 24 values sampled from a normal distribution with a mean of 9 and a standard deviation of 3. To ensure the results are reproducible, we used the set.seed() function to fix the state of the random number generator before each plot.

### I- and I'-charts from individual random normal measurements

```{r richart, fig.cap="I-chart from 24 random data from a normal distribution (mean = 20, SD = 3) with subgroup size = 1."}
set.seed(1)                   # fixate random number generator
x <- 1:24                     # subgroups
y <- rnorm(24, 20, 3)         # numerators
n <- runif(24, 80, 120)       # denominators

p1 <- compplot(x, y, chart = 'i', title = NULL)
p2 <- compplot(x, y * n, n, chart = 'i', title = NULL)

ylim <- range(layer_scales(p1)$y$range$range,
              layer_scales(p2)$y$range$range)

p1 + scale_y_continuous(limits = ylim)
```

```{r ripchart, fig.cap="I'-chart from 24 random, normal data with denominators ranging from 80 to 120."}
p2 + scale_y_continuous(limits = ylim)
```

### Xbar charts from multiple random normal measurements

```{r rxbarchart1, fig.cap="Xbar chart from 24 subgroups of 10 to 20 random normal data (mean = 9, SD = 1). I' limits a bit wider than Xbar limits."}
set.seed(1)
x <- rep(1:24, round(runif(24, 10, 20)))
y <- rnorm(length(x), 9)
p1 <- compplot(x, y, chart = 'xbar', title = NULL)

set.seed(6)
x <- rep(1:24, round(runif(24, 10, 20)))
y <- rnorm(length(x), 9)
p2 <- compplot(x, y, chart = 'xbar', title = NULL)

set.seed(8)
x <- rep(1:24, round(runif(24, 10, 20)))
y <- rnorm(length(x), 9)
p3 <- compplot(x, y, chart = 'xbar', title = NULL)

ylim <- range(layer_scales(p1)$y$range$range,
              layer_scales(p2)$y$range$range,
              layer_scales(p3)$y$range$range)

p1 + scale_y_continuous(limits = ylim)

```

```{r rxbarchart2, fig.cap="Xbar chart from 24 subgroups of 10 to 20 random normal data. I' limits close to Xbar limits."}

p2 + scale_y_continuous(limits = ylim)
```

```{r rxbarchart3, fig.cap="Xbar chart from 24 subgroups of 10 to 20 random normal data. I' limits a bit tigther than Xbar limits."}

p3 + scale_y_continuous(limits = ylim)
```

### P- and P'-charts from random binomial data

```{r rppchart, fig.cap="P chart of 24 random data from a binomial distribution (p = 0.1, subgroup size ranging from 100 to 120)."}
set.seed(1)
x <- 1:24
n <- round(runif(24, 100, 120))
y <- rbinom(24, n, 0.1)

p1 <- compplot(x, y, n, 'p', title = NULL)
p2 <- compplot(x, y, n, 'pp', title = NULL)


ylim <- range(layer_scales(p1)$y$range$range,
              layer_scales(p2)$y$range$range)

p1 + scale_y_continuous(limits = ylim)
```

```{r rpchart, fig.cap="P'-chart of 24 random data from a binomial distribution."}
p2 + scale_y_continuous(limits = ylim)
```

### U- and U'-charts from random poisson data

```{r ruchart, fig.cap="U chart from 24 random data from a poisson distribution (mean = 25, subgroup size ranging from 90 to 110)."}
set.seed(1)
x <- 1:24
n <- (runif(24, 90, 110))
y <- rpois(24, 25)

p1 <- compplot(x, y, n, chart = 'u', title = NULL)
p2 <- compplot(x, y, n, chart = 'up', title = NULL)

ylim <- range(layer_scales(p1)$y$range$range,
              layer_scales(p2)$y$range$range)

p1 + scale_y_continuous(limits = ylim)
```

```{r rupchart, fig.cap="U'-chart from 24 random data from a poisson distribution."}

p2 + scale_y_continuous(limits = ylim)
```

## References
